# Requirements Quality Checklist

**Spec**: MES 系统对接集成  
**Created**: 2026-01-25  
**Focus**: 功能需求完整性与可执行性验证  
**Scope**: 仅验证功能需求质量，排除非功能需求（性能、安全、可观测性等）

---

## 使用说明

- ✅ **通过**: 需求清晰、完整、可执行
- ⚠️ **需改进**: 需求基本明确，但存在细节模糊或可能导致实施偏差
- ❌ **不通过**: 需求缺失、矛盾或无法执行
- 🔍 **建议澄清**: 可选的进一步澄清，不阻塞规划

---

## 1. 功能完整性检查

### 1.1 核心用户场景覆盖

| ID | 检查项 | 状态 | 备注 |
|---|---|---|---|
| C-001 | 所有核心用户故事是否都有明确定义？ | ✅ | 7个用户故事覆盖完整流程：批次接收→预包装拉取→产线查询→报工→数据修正 |
| C-002 | 每个用户故事是否包含完整的验收场景？ | ✅ | 31个验收场景（Given-When-Then格式），覆盖正常流程和异常情况 |
| C-003 | 是否有端到端的业务流程验收场景？ | ✅ | Story 1-2-3-4-5-6形成完整端到端流程，Story 7覆盖数据修正场景 |
| C-004 | 边界场景是否有明确处理规则？ | ✅ | 11个边界场景明确定义（网络异常、重复推送、板件码不存在、并发冲突等） |

### 1.2 数据流完整性

| ID | 检查项 | 状态 | 备注 |
|---|---|---|---|
| C-005 | 数据入口（批次推送）是否定义了所有必填字段？ | ✅ | FR-002/FR-003明确定义批次和工单必填字段 |
| C-006 | 数据处理流程是否覆盖所有中间状态？ | ✅ | FR-018定义6种工单状态：未拉取→拉取中→已拉取→拉取失败/无预包装数据/更新中 |
| C-007 | 数据输出（查询接口）是否明确返回字段范围？ | ✅ | FR-019/FR-020/FR-021要求返回"全部字段"，FR-022明确禁止字段裁剪 |
| C-008 | 数据修正流程是否定义了覆盖和保留规则？ | ✅ | FR-033/FR-034/FR-035明确：覆盖预包装数据，保留报工记录，处理板件数量变化 |

### 1.3 状态转换完整性

| ID | 检查项 | 状态 | 备注 |
|---|---|---|---|
| C-009 | 工单状态是否覆盖所有业务场景？ | ✅ | 6种状态覆盖：初始化→拉取→成功/失败→修正（更新中） |
| C-010 | 状态转换触发条件是否明确？ | ✅ | FR-005/FR-015/FR-017/FR-032明确定义状态转换时机 |
| C-011 | 异常状态的恢复路径是否定义？ | ✅ | FR-017明确"拉取失败"→人工重置→"未拉取"；FR-038定义失败不破坏原有数据 |
| C-012 | "更新中"状态的并发处理是否明确？ | ✅ | FR-040/FR-040a明确查询返回HTTP 409，FR-041明确报工不受影响 |

---

## 2. 需求清晰度检查

### 2.1 接口定义清晰度

| ID | 检查项 | 状态 | 备注 |
|---|---|---|---|
| C-013 | 批次推送接口的路径、方法、参数是否明确？ | ✅ | FR-001明确路径（POST `/第三方系统/ordersmgt/第三方系统/batchTaskPush`），FR-002定义必填字段 |
| C-014 | 第三方预包装接口的调用格式是否明确？ | ✅ | FR-011明确请求格式：`{"service": {"name": "getPrepackageInfo"}, "payload": {...}}` |
| C-015 | 产线查询接口的输入输出是否明确？ | ✅ | FR-019/FR-020/FR-021明确输入（板件码）和输出（全量字段） |
| C-016 | 报工接口的必填字段是否明确？ | ✅ | FR-027明确必填字段：板件码、板件状态、工位编码 |

### 2.2 数据结构清晰度

| ID | 检查项 | 状态 | 备注 |
|---|---|---|---|
| C-017 | 批次数据结构是否明确？ | ✅ | FR-004列出批次所有字段：批次号、类型、日期、简易批次号、工单信息 |
| C-018 | 预包装数据结构（含嵌套）是否明确？ | ✅ | FR-012/FR-013定义多层嵌套：订单→箱码→部件，FR-014明确standardList处理 |
| C-019 | 报工记录数据结构是否明确？ | ✅ | FR-028/FR-029定义报工字段：板件码、状态、工位、时间 |
| C-020 | 数据修正日志结构是否明确？ | ✅ | Key Entities定义WorkOrderCorrectionLog：操作人、时间、工单号、原因、变化摘要 |

### 2.3 业务规则清晰度

| ID | 检查项 | 状态 | 备注 |
|---|---|---|---|
| C-021 | 定时任务的调度频率是否明确？ | ✅ | FR-008明确：每1秒执行一次 |
| C-022 | 定时任务的执行互斥机制是否明确？ | ✅ | FR-016明确：同一时间只有一个实例，上次未完成则跳过本次调度 |
| C-023 | 重试策略（间隔、次数、失败处理）是否明确？ | ✅ | FR-017明确指数退避：1s/2s/4s，最多3次，失败后标记"拉取失败" |
| C-024 | 幂等性处理规则是否明确？ | ✅ | FR-007（批次推送更新）、FR-030（报工状态转换去重） |

---

## 3. 需求可测性检查

### 3.1 用户故事独立可测性

| ID | 检查项 | 状态 | 备注 |
|---|---|---|---|
| C-025 | 每个用户故事是否包含"Independent Test"说明？ | ✅ | 所有7个用户故事均有独立测试步骤 |
| C-026 | 验收场景是否可独立执行验证？ | ✅ | 31个验收场景均为Given-When-Then格式，可转换为自动化测试 |
| C-027 | 边界场景是否可独立测试？ | ✅ | 11个边界场景均有明确触发条件和预期结果 |

### 3.2 需求可验证性

| ID | 检查项 | 状态 | 备注 |
|---|---|---|---|
| C-028 | 数据接收是否可验证？ | ✅ | Story 1场景4：验证数据库中所有字段与推送数据一致 |
| C-029 | 数据拉取是否可验证？ | ✅ | Story 2场景1：验证接口调用、数据入库、状态更新 |
| C-030 | 查询功能是否可验证？ | ✅ | Story 3/4/5：验证返回字段完整性 |
| C-031 | 报工功能是否可验证？ | ✅ | Story 6场景1/2：验证报工记录存储和时间顺序 |
| C-032 | 数据修正是否可验证？ | ✅ | Story 7场景1：验证数据覆盖+报工保留 |

### 3.3 错误处理可验证性

| ID | 检查项 | 状态 | 备注 |
|---|---|---|---|
| C-033 | 参数校验失败是否有明确的错误响应？ | ✅ | Story 1场景2、Story 6场景3：验证校验失败错误 |
| C-034 | 网络异常/接口失败是否有明确处理？ | ✅ | Story 2场景3、边界场景2：验证重试和失败标记 |
| C-035 | 数据不存在的错误提示是否明确？ | ✅ | Story 3场景2、Story 5场景3、Story 6场景4：验证"不存在"提示 |
| C-036 | 并发冲突的错误响应是否明确？ | ✅ | Story 7场景4：验证HTTP 409和"数据更新中"提示 |

---

## 4. 需求一致性检查

### 4.1 跨用户故事一致性

| ID | 检查项 | 状态 | 备注 |
|---|---|---|---|
| C-037 | 板件码唯一性假设是否贯穿所有场景？ | ✅ | 所有查询和报工场景均基于板件码唯一性假设（Assumption 8） |
| C-038 | 工单状态定义在不同场景中是否一致？ | ✅ | FR-018统一定义6种状态，所有场景使用一致 |
| C-039 | "全量字段"返回要求是否一致？ | ✅ | FR-019/FR-020/FR-021/FR-022一致要求返回全量字段 |
| C-040 | 报工记录独立性在修正场景中是否保持？ | ✅ | FR-034/FR-041一致保证报工不受数据修正影响（Assumption 12） |

### 4.2 需求与验收场景一致性

| ID | 检查项 | 状态 | 备注 |
|---|---|---|---|
| C-041 | FR-001-FR-007与Story 1验收场景是否一致？ | ✅ | 批次推送需求与验收场景完全对应 |
| C-042 | FR-008-FR-018与Story 2验收场景是否一致？ | ✅ | 预包装拉取需求与验收场景完全对应 |
| C-043 | FR-019-FR-025与Story 3/4/5验收场景是否一致？ | ✅ | 查询需求与验收场景完全对应 |
| C-044 | FR-026-FR-030与Story 6验收场景是否一致？ | ✅ | 报工需求与验收场景完全对应 |
| C-045 | FR-031-FR-041与Story 7验收场景是否一致？ | ✅ | 数据修正需求与验收场景完全对应 |

### 4.3 Key Entities与需求一致性

| ID | 检查项 | 状态 | 备注 |
|---|---|---|---|
| C-046 | 批次实体定义是否覆盖FR-004的字段？ | ✅ | Key Entities的批次定义与FR-004一致 |
| C-047 | 工单实体是否包含状态字段？ | ✅ | Key Entities的工单定义包含"预包装明细拉取状态" |
| C-048 | 报工记录实体是否支持独立性假设？ | ✅ | Key Entities明确报工记录独立于板件，通过板件码关联 |
| C-049 | 是否新增了邮件通知相关实体？ | ⚠️ | Key Entities新增EmailNotificationConfig，但FR-017a/FR-017b未定义配置存储需求 |

**改进建议 C-049**: 考虑在FR中补充邮件配置的存储和管理需求，或在Assumption中说明配置以环境变量/配置文件方式管理

---

## 5. 需求可行性检查

### 5.1 技术可行性

| ID | 检查项 | 状态 | 备注 |
|---|---|---|---|
| C-050 | Spring @Scheduled能否满足1秒调度+互斥需求？ | ✅ | FR-009明确使用Spring原生调度，互斥可通过@Scheduled(fixedDelay)或分布式锁实现 |
| C-051 | 预包装数据的嵌套结构能否正确解析？ | ✅ | FR-012/FR-014明确要求解析多层嵌套和standardList（list<object>） |
| C-052 | 指数退避重试能否在Spring中实现？ | ✅ | FR-017可通过Spring Retry或手动实现（Thread.sleep + for循环） |
| C-053 | 事务能否保证预包装数据覆盖的原子性？ | ✅ | FR-037要求事务性操作，Spring @Transactional可满足 |

### 5.2 数据一致性可行性

| ID | 检查项 | 状态 | 备注 |
|---|---|---|---|
| C-054 | 报工记录保留与板件删除的关系是否可行？ | ✅ | FR-035明确：删除板件但保留报工，通过状态标记"关联板件已失效" |
| C-055 | "更新中"状态的并发控制是否可行？ | ✅ | FR-040/FR-041：查询检查状态返回409，报工直接写入独立表，可行 |
| C-056 | 板件码唯一性约束能否保证？ | ✅ | Assumption 8假设板件码唯一，数据库可通过唯一索引强制 |

### 5.3 运维可行性

| ID | 检查项 | 状态 | 备注 |
|---|---|---|---|
| C-057 | 失败工单的手动修复是否可行？ | ✅ | Clarification明确：运维人员通过SQL直接修改工单状态为"未拉取" |
| C-058 | 邮件通知的SMTP配置是否可行？ | ✅ | FR-017b明确使用QQ邮箱SMTP（smtp.qq.com:587/465），Spring Mail支持 |
| C-059 | 数据修正日志的审计追溯是否可行？ | ✅ | FR-039要求记录操作日志，Key Entities定义WorkOrderCorrectionLog |

---

## 6. 需求优先级合理性检查

### 6.1 优先级定义清晰度

| ID | 检查项 | 状态 | 备注 |
|---|---|---|---|
| C-060 | 每个用户故事是否明确优先级？ | ✅ | 7个用户故事均标注P1/P2/P3 |
| C-061 | 优先级是否包含理由说明？ | ✅ | 每个用户故事的"Why this priority"字段解释优先级原因 |

### 6.2 优先级依赖合理性

| ID | 检查项 | 状态 | 备注 |
|---|---|---|---|
| C-062 | P1故事是否为后续功能的前置依赖？ | ✅ | Story 1（批次接收）和Story 2（预包装拉取）是P2查询和P3报工的前置条件 |
| C-063 | P2故事之间是否有执行顺序依赖？ | ✅ | Story 3/4/5（查询）并列P2，无顺序依赖；Story 7（数据修正）依赖Story 1/2 |
| C-064 | P3故事是否可以独立延后实现？ | ✅ | Story 6（报工）可在P1/P2完成后独立实现 |

---

## 7. 遗漏检查

### 7.1 功能遗漏检查

| ID | 检查项 | 状态 | 备注 |
|---|---|---|---|
| C-065 | 是否遗漏批次查询功能？ | 🔍 | 仅定义板件码查询工单/批次，未定义批次号直接查询批次信息的接口 |
| C-066 | 是否遗漏工单列表查询功能？ | 🔍 | 未定义按批次号查询工单列表的接口 |
| C-067 | 是否遗漏报工记录查询功能？ | 🔍 | 未定义按板件码或工单查询报工历史的接口 |
| C-068 | 是否遗漏数据修正权限控制？ | 🔍 | FR-031未定义"管理员"的身份验证和权限控制机制 |

**建议 C-065/C-066/C-067**: 如果运维或管理需要这些查询能力，考虑在后续迭代补充。如不需要，在Assumption中说明"仅提供板件码查询，不提供批次/工单直接查询"

**建议 C-068**: 如果环境为内网隔离（Assumption 7），可接受无权限控制。否则需补充身份验证需求

### 7.2 边界场景遗漏检查

| ID | 检查项 | 状态 | 备注 |
|---|---|---|---|
| C-069 | 是否遗漏"预包装数据为空"的场景？ | ✅ | Story 2场景2明确处理：标记"无预包装数据"状态 |
| C-070 | 是否遗漏"板件数量为0"的场景？ | ✅ | Story 2场景2覆盖（无预包装数据=板件数量为0） |
| C-071 | 是否遗漏"批次下所有工单都失败"的场景？ | 🔍 | 未明确定义批次级别的失败处理（是否需要批次状态？） |
| C-072 | 是否遗漏"报工时板件正在更新"的场景？ | ✅ | FR-041明确：报工不受工单状态影响，独立写入报工表 |

**建议 C-071**: 如不需要批次级别状态管理，可在Assumption中说明"批次状态由所有工单状态推导，不单独存储"

---

## 总体评估

| 维度 | 评分 | 说明 |
|---|---|---|
| **功能完整性** | 95% | 核心功能完整，仅有少量可选查询功能未明确（C-065/C-066/C-067） |
| **需求清晰度** | 98% | 接口、数据结构、业务规则清晰，仅邮件配置存储需轻微改进（C-049） |
| **需求可测性** | 100% | 所有功能均有独立可测的验收场景，错误处理可验证 |
| **需求一致性** | 100% | 需求、验收场景、实体定义保持一致 |
| **需求可行性** | 100% | 所有技术、数据一致性、运维要求均可行 |
| **优先级合理性** | 100% | 优先级定义清晰，依赖关系合理 |

---

## 检查结论

✅ **功能需求质量通过，可进入技术规划阶段**

### 通过理由

1. **完整性**: 7个用户故事+31个验收场景+11个边界场景覆盖完整业务流程
2. **清晰度**: 50个功能需求（FR-001至FR-050）明确定义接口、数据结构、业务规则
3. **可测性**: 所有用户故事包含独立测试步骤，验收场景为Given-When-Then格式
4. **一致性**: 需求、验收场景、实体定义、假设条件保持一致
5. **可行性**: 技术实现、数据一致性、运维操作均可行

### 建议改进（不阻塞规划）

1. **C-049**: 明确邮件配置存储方式（环境变量/配置文件/数据库）
2. **C-065/C-066/C-067**: 如有需要，补充批次/工单/报工记录的直接查询接口
3. **C-068**: 如非内网隔离环境，补充数据修正权限控制需求
4. **C-071**: 明确是否需要批次级别状态管理

---

## 下一步行动

1. **立即执行**: `@command://speckit.plan` - 创建技术实施计划
2. **可选优化**: 基于C-049/C-065-068建议进一步澄清规格（不强制）
3. **规划重点**:
   - 数据库表结构设计（工单状态字段、报工表独立性）
   - 定时任务实现（Spring @Scheduled + 互斥机制）
   - 指数退避重试逻辑（Spring Retry或手动实现）
   - 邮件服务集成（Spring Mail + JavaMailSender）
   - 并发控制实现（"更新中"状态检测）
   - API接口定义（含HTTP 409响应）
