# Feature Specification: MES 系统对接集成

**Feature Branch**: `001-mes-integration`  
**Created**: 2026-01-21  
**Status**: Draft  
**Input**: User description: "我方系统与第三方 MES 系统对接需求" + "工单数据修正与重新拉取，覆盖预包装数据但保留报工记录"

## Clarifications

### Session 2026-01-25

- Q: 当第三方 MES 系统的预包装数据接口返回错误或超时时，系统的重试策略应该是什么？ → A: 指数退避重试（1s, 2s, 4s），最多3次，失败后标记工单为"拉取失败"状态
- Q: 当管理员需要查询或管理处于"拉取失败"状态的工单时，系统应该提供什么样的界面或API？ → A: 仅提供数据库直接访问，运维人员通过SQL手动查询和修改工单状态
- Q: 第三方 MES 系统与我方系统之间的接口调用需要什么样的认证和授权机制？ → A: 无认证，通过内网隔离保证安全（仅限内网访问）
- Q: 系统需要记录哪些级别的日志来支持故障排查和性能监控？ → A: 关键操作日志（接口调用、状态变更、错误）+ 性能指标（响应时间、吞吐量）
- Q: 当工单数据重新拉取过程中（覆盖预包装数据），如果同时有产线客户端查询该工单的板件信息，系统应该如何处理以保证数据一致性？ → A: 在工单表增加"更新中"状态，查询时检测到此状态返回"数据更新中，请稍后重试"提示
- Q: 拉取失败时需要通过什么方式通知管理员？ → A: 通过QQ邮箱发送失败通知邮件至指定邮箱地址

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 批次与工单数据接收 (Priority: P1)

第三方 MES 系统向我方系统推送生产批次及工单基础信息。批次数据包含批次号、批次类型、生产日期、优化文件列表及关联的工单信息。我方系统接收并存储这些数据，为后续预包装数据拉取和产线查询提供基础。

**Why this priority**: 这是整个对接流程的数据入口，没有批次和工单基础数据，后续所有功能都无法进行。是系统对接的核心前置条件。

**Independent Test**: 可通过模拟第三方 MES 系统调用批次推送接口，验证我方系统是否正确接收、解析并存储批次及工单数据。检查数据库中批次表和工单表的数据完整性。

**Acceptance Scenarios**:

1. **Given** 第三方 MES 系统准备推送一个包含 2 个工单的批次, **When** 调用批次新增接口推送数据, **Then** 我方系统返回成功响应，批次和 2 个工单数据完整入库
2. **Given** 第三方 MES 系统推送的批次数据缺少必填字段（如 batchNum）, **When** 调用批次新增接口, **Then** 我方系统返回参数校验失败错误，数据不入库
3. **Given** 第三方 MES 系统重复推送相同批次号的数据, **When** 第二次推送相同 batchNum, **Then** 我方系统根据业务规则处理（幂等性保证：更新）
4. **Given** 批次数据已成功入库, **When** 查询数据库中的批次和工单表, **Then** 所有字段（批次号、类型、生产日期、优化文件名、工单号、线路、订单类型等）与推送数据一致
5. **Given** 批次包含加急标识（urgency=1）, **When** 批次数据入库后, **Then** 系统正确记录加急状态，供后续优先处理使用

---

### User Story 2 - 预包装数据自动拉取 (Priority: P1)

我方系统通过定时任务机制，按工单维度自动拉取尚未获取预包装明细的工单数据。系统每秒扫描一次待处理工单列表，使用 batchNum + workId 联合条件调用第三方 MES 系统接口获取预包装信息，成功后将预包装数据完整入库并更新工单状态。

**Why this priority**: 预包装数据是产线分拣、包装和报工的核心依据。自动拉取机制确保数据及时性，避免人工干预。与 P1 Story 1 并列核心功能。

**Independent Test**: 可通过在数据库中插入一个未拉取预包装明细的工单记录，启动定时任务，观察系统是否在 1 秒内调用第三方接口并成功拉取数据入库，同时更新工单状态为"已拉取"。

**Acceptance Scenarios**:

1. **Given** 数据库中存在一个状态为"未拉取预包装明细"的工单, **When** 定时任务执行, **Then** 系统调用第三方 MES 接口获取该工单的预包装数据，数据入库，工单状态更新为"已拉取"
2. **Given** 第三方 MES 接口返回空数据（工单无预包装信息）, **When** 定时任务调用接口, **Then** 系统记录该工单为"无预包装数据"状态，不再重复拉取
3. **Given** 第三方 MES 接口调用失败（网络异常或超时）, **When** 定时任务执行, **Then** 系统执行指数退避重试（1s, 2s, 4s间隔），3次重试均失败后工单状态标记为"拉取失败"，并发送邮件通知至管理员邮箱（243219169@qq.com），邮件包含失败详情（批次号、工单号、失败原因）
4. **Given** 定时任务正在执行拉取操作, **When** 下一个调度周期（1秒后）到达时, **Then** 系统检测到上一次任务尚未完成，本次调度跳过执行，等待上一次任务完成后再进行下一轮拉取
5. **Given** 预包装数据包含多层嵌套结构（订单→箱码→部件）, **When** 数据拉取成功, **Then** 所有层级数据完整入库，包括订单信息、箱码列表、部件明细、标准码集合等
6. **Given** 定时任务拉取到预包装数据后, **When** 系统处理 standardList 字段（list 类型，元素为对象）, **Then** 正确解析并存储 key-value 结构（如 `[{"00041":1, "00311":1}]`）

---

### User Story 3 - 板件码查询工单与批次信息 (Priority: P2)

产线客户端系统通过板件码查询该板件所属的工单及批次完整信息。返回结果包含工单的全部字段（工单号、线路、订单类型、优化文件等）以及批次的全部字段（批次号、批次类型、生产日期、加急标识等）。

**Why this priority**: 产线操作人员需要通过板件码快速定位板件所属的生产批次和工单，支撑现场生产管理和追溯。是产线查询功能的基础。

**Independent Test**: 可通过在数据库中准备一个完整的批次-工单-预包装-板件数据链，调用板件码查询接口，验证返回的工单和批次信息是否完整且准确。

**Acceptance Scenarios**:

1. **Given** 板件码 "PART123" 属于工单 "WO001"，工单 "WO001" 属于批次 "BATCH001", **When** 产线客户端通过板件码查询, **Then** 返回工单 "WO001" 的全部字段和批次 "BATCH001" 的全部字段
2. **Given** 板件码在系统中不存在, **When** 产线客户端查询该板件码, **Then** 返回"板件码不存在"提示
3. **Given** 板件码存在但关联的工单或批次数据不完整, **When** 查询该板件码, **Then** 返回已有数据，缺失字段标记为空或提示"数据不完整"

---

### User Story 4 - 板件码查询包装数据 (Priority: P2)

产线客户端系统通过板件码查询该板件所在的包装结构信息。返回结果包含板件所在的箱码信息、箱码所属的包装信息，以及包装结构中涉及的所有层级对象的全部字段（订单信息、箱码列表、部件明细等）。

**Why this priority**: 产线分拣和包装环节需要根据板件码查询其包装位置（箱码、层、片、分拣顺序等），确保正确包装和出货。与 P2 Story 3 同等重要。

**Independent Test**: 可通过准备一个完整的预包装数据结构（订单→箱码→部件），调用板件码查询包装数据接口，验证返回的箱码、层级、分拣顺序等信息是否完整。

**Acceptance Scenarios**:

1. **Given** 板件码 "PART123" 位于箱码 "BOX001" 的第 2 层第 3 片, **When** 产线客户端查询该板件码的包装数据, **Then** 返回箱码 "BOX001" 的完整信息（楼栋、户型、房间号、套数、颜色），以及该板件在箱内的位置（层、片、分拣顺序）
2. **Given** 板件码对应的包装数据包含嵌套结构（订单→prePackageInfo→boxInfoList→partInfoList）, **When** 查询包装数据, **Then** 返回所有层级的完整字段，包括订单号、客户名称、箱码、部件条码、坐标、标准码集合等
3. **Given** 板件码关联的箱码包含多个部件, **When** 查询包装数据, **Then** 返回该箱码内所有部件的完整列表
4. **Given** 板件码关联的预包装数据中包含 standardList（list 类型，元素为对象如 `[{"00041":1}]`）, **When** 查询包装数据, **Then** 正确返回 standardList 的完整内容

---

### User Story 5 - 板件码查询板件详细信息 (Priority: P2)

产线客户端系统通过板件码查询该板件自身的详细信息，包括板件 ID、板件描述、花色、尺寸（长宽高）、坐标（x/y/z 轴）、分拣顺序等全部业务字段。

**Why this priority**: 产线操作人员需要查看板件的物理属性和分拣信息，支撑现场分拣和定位操作。与其他查询功能同等重要。

**Independent Test**: 可通过准备一个板件数据记录（包含所有字段），调用板件详细信息查询接口，验证返回的板件属性是否完整且准确。

**Acceptance Scenarios**:

1. **Given** 板件码 "PART123" 对应的板件信息包含板件 ID、描述、花色、尺寸、坐标等字段, **When** 产线客户端查询该板件码, **Then** 返回板件的全部业务字段
2. **Given** 板件码关联的板件信息中部分字段为空（如坐标为空）, **When** 查询板件详细信息, **Then** 返回已有字段，空字段标记为 null 或空字符串
3. **Given** 板件码在系统中不存在, **When** 查询板件详细信息, **Then** 返回"板件码不存在"提示

---

### User Story 6 - 板件报工 (Priority: P3)

产线客户端系统通过板件码、板件状态、工位编码、工位名称等信息向我方系统提交板件报工记录。系统记录板件在各工位的生产状态变化，支撑生产进度追踪和工艺流程管理。

**Why this priority**: 报工功能用于记录板件生产过程，虽然重要但相对于数据接收、拉取和查询功能，可以在后期实现。优先级为 P3。

**Independent Test**: 可通过模拟产线客户端提交一条报工记录（包含板件码、状态、工位信息），验证系统是否正确记录并可查询到该报工记录。

**Acceptance Scenarios**:

1. **Given** 产线客户端提交板件 "PART123" 在工位 "C1A001" 的报工记录（状态为"加工完成"）, **When** 报工接口调用成功, **Then** 系统记录该板件的状态变化和工位信息
2. **Given** 同一板件在不同工位多次报工, **When** 产线客户端多次提交报工记录, **Then** 系统按时间顺序记录每次报工，形成板件的生产轨迹
3. **Given** 报工数据缺少必填字段（如板件码或工位编码）, **When** 提交报工记录, **Then** 系统返回参数校验失败错误，报工记录不入库
4. **Given** 板件码在系统中不存在, **When** 提交报工记录, **Then** 系统返回"板件码不存在"错误或根据业务规则决定是否允许报工（如先创建板件记录）

---

### User Story 7 - 工单数据修正与重新拉取 (Priority: P2)

当发现上游第三方 MES 系统推送的工单数据有误时，管理人员需要将工单状态重置为"未拉取"，触发定时任务重新拉取该工单的预包装数据。系统在重新拉取时应覆盖原有的预包装信息和板件数据，但必须保留板件已经产生的报工记录，确保生产追溯信息不丢失。

**Why this priority**: 数据修正是生产系统的重要保障功能，当上游数据错误时需要及时更正。虽然不如核心数据流程优先级高，但对保证数据准确性和生产连续性至关重要，优先级为 P2。

**Independent Test**: 可通过以下步骤独立测试：
1. 准备一个已拉取预包装数据的工单，该工单下的板件已有报工记录
2. 手动将工单状态改为"未拉取"
3. 启动定时任务，观察系统是否重新拉取预包装数据
4. 验证预包装数据和板件基础数据已更新
5. 验证板件的报工记录仍然完整保留

**Acceptance Scenarios**:

1. **Given** 工单 "WO001" 已拉取预包装数据，板件 "PART123" 已有 3 条报工记录, **When** 管理员将工单状态改为"未拉取"并触发定时任务重新拉取, **Then** 预包装数据和板件基础信息被新数据覆盖，但 3 条报工记录完整保留
2. **Given** 工单的预包装数据已入库，包含 50 个板件, **When** 工单状态重置后重新拉取，新数据只包含 45 个板件（5 个板件被上游删除）, **Then** 系统删除或标记删除 5 个不存在的板件，保留 45 个板件的更新数据，所有板件的报工记录不受影响
3. **Given** 工单重新拉取时，板件 "PART123" 的基础信息发生变化（如花色、尺寸修改）, **When** 数据覆盖完成后, **Then** 板件的基础信息更新为新值，但该板件的历史报工记录仍然关联到该板件，报工时间、工位、状态等信息不变
4. **Given** 工单状态改为"未拉取"后，在定时任务执行前产线客户端尝试查询该工单的板件信息, **When** 查询接口调用时, **Then** 系统返回当前数据库中的数据（旧数据）。定时任务开始重新拉取后，工单状态变为"更新中"，此时查询接口返回"工单数据更新中，请稍后重试"提示（HTTP 409），待定时任务完成后查询将返回更新后的数据
5. **Given** 重新拉取过程中第三方接口调用失败（网络异常）, **When** 定时任务执行, **Then** 工单保持"未拉取"状态，原有数据不被破坏，下次定时任务会自动重试
6. **Given** 多个工单同时被重置为"未拉取"状态, **When** 定时任务执行, **Then** 系统按顺序处理每个工单的重新拉取，每个工单独立完成数据覆盖和报工保留逻辑
7. **Given** 工单 "WO001" 的板件 "PART456" 在重新拉取前无报工记录，重新拉取后该板件被上游删除, **When** 数据覆盖完成, **Then** 板件 "PART456" 被删除或标记为无效，不影响其他板件

---

### Edge Cases

- **批次推送时网络异常或超时**：第三方 MES 系统推送批次数据时网络中断，我方系统是否返回适当的错误响应？第三方系统如何重试？
- **预包装数据拉取失败**：定时任务调用第三方接口失败（如接口超时、返回错误码），系统采用指数退避重试策略（1s, 2s, 4s），最多重试3次，失败后标记工单为"拉取失败"状态并发送邮件通知至管理员，需人工介入或等待上游系统恢复后手动重置工单状态。邮件发送失败不影响主业务流程，仅记录日志
- **同一批次号重复推送**：第三方 MES 系统重复推送相同批次号的数据，我方系统如何处理？是更新现有数据还是拒绝重复推送？
- **板件码不存在或关联数据缺失**：产线客户端查询一个系统中不存在的板件码，或板件关联的工单/批次/预包装数据缺失，系统返回什么提示？
- **定时任务长时间运行**：如果单次定时任务执行时间超过1秒（大量待处理工单），系统如何保证不会启动新的任务实例？是否需要设置最大执行时间限制？
- **预包装数据结构异常**：第三方 MES 系统返回的预包装数据结构不符合约定（如缺少必填字段、嵌套层级错误），系统如何容错处理？
- **报工数据幂等性**：同一板件在同一工位重复报工相同状态时，系统将拒绝重复记录；但状态改变时会接受新的报工记录，形成完整的状态转换轨迹
- **系统重启或宕机恢复**：系统重启后，未完成的预包装数据拉取任务如何恢复？是否会导致数据丢失或重复处理？
- **工单数据修正时的并发冲突**：当工单状态为"更新中"时，产线客户端查询该工单的板件信息会收到"工单数据更新中，请稍后重试"提示（HTTP 409），避免返回新旧混合数据。产线客户端需实现自动重试逻辑（建议间隔1秒重试，最多3次）
- **重新拉取时板件数量变化**：上游数据修正后，工单的板件数量发生显著变化（增加或减少），系统如何处理已删除板件的历史报工记录？这些报工记录是否应该标记为"关联板件已失效"？
- **重新拉取过程中的报工请求**：定时任务正在重新拉取并覆盖工单数据时，产线客户端同时提交该工单板件的报工请求，系统如何处理？是否会导致报工失败或报工记录丢失？

---

## Requirements *(mandatory)*

### Functional Requirements

#### 批次与工单数据接收

- **FR-001**: 系统 MUST 提供批次新增接口（POST `/第三方系统/ordersmgt/第三方系统/batchTaskPush`），接收第三方 MES 系统推送的批次及工单数据
- **FR-002**: 批次新增接口 MUST 验证请求参数的完整性和有效性，必填字段包括：batchNum（批次号）、batchType（批次类型）、productTime（生产日期）、optimizingFileList（优化文件列表）
- **FR-003**: 系统 MUST 支持一个批次下包含多个工单，每个工单 MUST 包含 workId（工单号）、route（线路）、orderType（订单类型）三个必填字段
- **FR-004**: 系统 MUST 将接收到的批次数据入库，包括批次基础信息（批次号、批次类型、生产日期、简易批次号）和关联的工单信息（工单号、线路、订单类型、优化文件名、工位编码、加急标识）
- **FR-005**: 系统 MUST 在批次数据入库时，为每个工单初始化"预包装明细是否已拉取"状态字段，初始值为"未拉取"
- **FR-006**: 批次新增接口 MUST 返回标准响应格式，包括 status（状态码：0=成功，1=失败）、msg（响应消息）、time（响应时间戳）
- **FR-007**: 系统 MUST 支持批次数据的幂等性处理，对于重复推送的相同批次号数据，根据业务规则决定是更新现有数据还是拒绝推送
- **FR-007a**: 批次新增接口和产线查询接口 MUST 仅限内网访问，不对公网暴露。系统通过网络隔离（如防火墙规则、VPC内网）保证接口安全，不实施应用层认证机制（如API Key或Token）

#### 预包装数据自动拉取

- **FR-008**: 系统 MUST 提供定时任务机制，每 1 秒执行一次，扫描状态为"未拉取预包装明细"的工单列表
- **FR-009**: 定时任务 MUST 使用 Spring 原生调度能力（如 @Scheduled）实现，不依赖外部调度框架（如 XXL-JOB）
- **FR-010**: 系统 MUST 为每个待处理工单，使用 batchNum + workId 联合条件调用第三方 MES 系统的"获取预包装信息接口"（服务名：getPrepackageInfo）
- **FR-011**: 调用第三方接口时 MUST 使用标准请求格式：`{"service": {"name": "getPrepackageInfo"}, "payload": {"batchNum": "批次号", "workId": "工单号"}}`
- **FR-012**: 系统 MUST 正确解析第三方接口返回的预包装数据结构，包括多层嵌套（订单→prePackageInfo→boxInfoList→partInfoList）
- **FR-013**: 系统 MUST 完整入库预包装数据，包括订单信息（订单号、客户名称、合同编号、收货人、安装地址等）、箱码信息（箱码、楼栋、户型、房间号、套数、颜色）、部件信息（部件条码、层、片、板件 ID、板件描述、花色、尺寸、坐标、分拣顺序、标准码集合）
- **FR-014**: 系统 MUST 正确处理 partInfoList 中的 standardList 字段（list 类型，元素为对象如 `[{"00041":1, "00311":1}]`），将其完整存储
- **FR-015**: 系统 MUST 在预包装数据成功入库后，更新对应工单的"预包装明细是否已拉取"状态为"已拉取"
- **FR-016**: 系统 MUST 实现定时任务执行互斥机制，确保同一时间只有一个定时任务实例在执行。当上一次定时任务尚未完成时，新的调度周期不启动新任务，避免并发执行导致重复拉取
- **FR-017**: 系统 MUST 支持预包装数据拉取失败的重试机制，采用指数退避策略：第1次重试间隔1秒，第2次间隔2秒，第3次间隔4秒，最多重试3次。当接口调用失败（网络异常、超时、第三方系统返回错误）且3次重试均失败后，工单状态标记为"拉取失败"
- **FR-017a**: 当工单状态标记为"拉取失败"后，系统 MUST 发送邮件通知至指定的管理员邮箱（243219169@qq.com），邮件内容包括：失败时间、批次号、工单号、失败原因、重试次数、错误消息
- **FR-017b**: 邮件通知 MUST 使用SMTP协议，配置为QQ邮箱SMTP服务（smtp.qq.com:587/465），使用提供的账号和授权码进行认证。邮件发送失败不阻塞主业务流程，仅记录ERROR日志
- **FR-018**: 系统 MUST 记录预包装数据拉取的处理状态，支持状态类型包括：未拉取、拉取中、已拉取、拉取失败、无预包装数据、更新中（工单数据重新拉取时使用）

#### 产线查询能力

- **FR-019**: 系统 MUST 提供板件码查询工单与批次信息接口，输入为板件码，输出包含板件所属工单的全部字段和工单所属批次的全部字段
- **FR-020**: 系统 MUST 提供板件码查询包装数据接口，输入为板件码，输出包含板件所在的箱码信息、箱码所属的包装信息，以及包装结构中涉及的所有层级对象的全部字段（订单信息、箱码列表、部件明细）
- **FR-021**: 系统 MUST 提供板件码查询板件详细信息接口，输入为板件码，输出包含板件自身的全部业务字段（板件 ID、板件描述、花色、尺寸、坐标、分拣顺序、标准码集合等）
- **FR-022**: 所有查询接口 MUST 返回全量字段信息，不做字段裁剪或简化视图
- **FR-023**: 查询接口 MUST 支持字段扩展，当业务新增字段时，不破坏现有接口的兼容性
- **FR-024**: 当板件码在系统中不存在时，查询接口 MUST 返回明确的错误提示（如"板件码不存在"）
- **FR-025**: 当板件码关联的数据不完整（如工单或批次数据缺失）时，查询接口 MUST 返回已有数据，并在响应中标记缺失字段或提供"数据不完整"提示

#### 板件报工能力

- **FR-026**: 系统 MUST 提供板件报工接口，接收产线客户端提交的报工信息，包括板件码、板件状态值、工位编码、工位名称
- **FR-027**: 报工接口 MUST 验证必填字段的完整性，包括板件码、板件状态、工位编码
- **FR-028**: 系统 MUST 记录板件在各工位的生产状态变化，支持同一板件在不同工位多次报工
- **FR-029**: 系统 MUST 按时间顺序记录每次报工，形成板件的完整生产轨迹
- **FR-030**: 报工接口 MUST 支持报工数据的幂等性处理，采用状态转换去重策略：只接受与该板件在该工位上一次报工状态不同的报工记录。相同状态的重复报工将被拒绝，但允许状态改变时的多次报工

#### 工单数据修正与重新拉取能力

- **FR-031**: 系统 MUST 支持管理员手动将工单状态重置为"未拉取"，以触发定时任务重新拉取该工单的预包装数据
- **FR-032**: 当工单状态被重置为"未拉取"后，定时任务 MUST 在下一个调度周期（1 秒内）自动检测到该工单并重新调用第三方接口拉取预包装数据。在开始重新拉取前，系统 MUST 将工单状态更新为"更新中"
- **FR-033**: 重新拉取预包装数据时，系统 MUST 完全覆盖该工单的原有预包装信息，包括订单信息、箱码列表、板件基础数据（板件 ID、描述、花色、尺寸、坐标、分拣顺序、标准码集合等）
- **FR-034**: 重新拉取过程中，系统 MUST 保留该工单下所有板件的历史报工记录，报工记录不受数据覆盖影响，继续关联到对应的板件码
- **FR-035**: 当重新拉取的预包装数据中板件数量减少（上游删除了部分板件）时，系统 MUST 删除或标记删除不再存在的板件，但这些板件的历史报工记录 MUST 保留并标记为"关联板件已失效"
- **FR-036**: 当重新拉取的预包装数据中板件数量增加（上游新增了板件）时，系统 MUST 新增这些板件的基础数据，新板件初始无报工记录
- **FR-037**: 重新拉取过程 MUST 支持事务性操作，确保预包装数据覆盖的原子性，避免出现部分更新导致的数据不一致
- **FR-038**: 当重新拉取第三方接口调用失败时，系统 MUST 保持工单"未拉取"状态，原有数据不被破坏，下次定时任务会自动重试
- **FR-039**: 系统 MUST 记录工单数据修正的操作日志，包括谁在何时将工单状态改为"未拉取"，以及重新拉取的时间、结果、数据变化摘要（如板件数量变化）
- **FR-040**: 在工单数据重新拉取过程中，如果产线客户端并发查询该工单的板件信息，系统 MUST 检测工单状态为"更新中"并返回明确提示："工单数据更新中，请稍后重试"，不返回部分新旧混合的数据
- **FR-040a**: 当工单状态为"更新中"时，产线查询接口 MUST 返回 HTTP 状态码 409（Conflict）或业务错误码，响应消息包含预计等待时间（如"预计1秒后完成"）
- **FR-041**: 在工单数据重新拉取过程中，如果产线客户端并发提交该工单板件的报工请求，系统 MUST 接受报工并正确记录，报工记录不丢失，确保报工功能不受数据更新影响（报工表独立于板件表，不受工单状态影响）
- **FR-041a**: 重新拉取完成后，系统 MUST 将工单状态从"更新中"更新为"已拉取"，恢复产线查询的正常访问

#### 可靠性与扩展性

- **FR-042**: 系统 MUST 支持失败重试机制，针对预包装数据拉取失败、第三方接口异常、网络异常等场景，提供自动重试能力
- **FR-043**: 系统 MUST 支持状态补偿处理，避免因单次失败导致工单永久无法拉取预包装明细
- **FR-044**: 状态字段设计 MUST 支持后续扩展更多状态类型（如：处理中、失败、部分成功、异常挂起）
- **FR-045**: 系统 MUST 在异常恢复后（如系统重启、宕机恢复），能够通过工单状态字段继续补偿处理未完成的任务
- **FR-046**: 定时任务调度逻辑 MUST 与业务处理逻辑解耦，支持后续扩展为分布式调度或集群模式
- **FR-047**: 系统 MUST 记录关键操作日志，包括：批次推送接口调用（请求来源、批次号、工单数量、处理结果）、预包装数据拉取（工单号、接口调用时间、响应状态、重试次数）、工单状态变更（变更前状态、变更后状态、触发原因、操作时间）、报工记录提交（板件码、工位、状态、报工时间）
- **FR-048**: 系统 MUST 记录接口调用失败和异常情况的ERROR级别日志，包含错误码、错误消息、堆栈信息（如适用）、请求上下文（批次号/工单号/板件码）
- **FR-049**: 系统 MUST 收集并记录性能指标，包括：批次推送接口响应时间、预包装数据拉取接口响应时间、产线查询接口响应时间、定时任务执行时长、每秒处理的工单数量、接口成功率和失败率
- **FR-050**: 日志记录 MUST 不包含敏感信息（如完整的请求/响应JSON、SQL语句参数），仅记录关键业务标识（批次号、工单号、板件码）和操作结果

---

### Key Entities

- **批次（Batch）**: 代表第三方 MES 系统推送的生产批次，包含批次号（唯一标识）、批次类型（衣柜柜体/橱柜柜体/门板等）、生产日期、简易批次号等属性。一个批次下可包含多个工单。

- **工单（WorkOrder）**: 代表批次下的具体生产工单，包含工单号（唯一标识）、线路、订单类型、优化文件名、工位编码、加急标识、预包装明细拉取状态等属性。工单是预包装数据拉取的主要维度。

- **预包装信息（PrePackageInfo）**: 代表工单对应的预包装明细数据，包含订单信息（订单号、客户名称、合同编号、收货人、安装地址、产品类型等）和箱码列表（多个箱码及其包含的部件明细）。

- **箱码（BoxCode）**: 代表预包装中的一个箱子，包含箱码（唯一标识）、楼栋、户型、房间号、套数、颜色等属性，以及该箱内包含的部件列表。

- **部件/板件（Part）**: 代表预包装中的最小单元，包含板件码（唯一标识）、层、片、板件 ID、板件描述、花色、尺寸（长宽高）、坐标（x/y/z 轴）、分拣顺序、标准码集合等属性。板件是产线查询和报工的核心对象。

- **报工记录（WorkReport）**: 代表板件在各工位的生产状态记录，包含板件码、板件状态值、工位编码、工位名称、报工时间等属性。支持同一板件在不同工位的多次报工。报工记录独立于板件基础数据，即使板件被删除或更新，报工记录仍然保留。

- **工单数据修正日志（WorkOrderCorrectionLog）**: 记录工单数据修正操作的审计信息，包含操作人、操作时间、工单号、修正原因、数据变化摘要（如板件数量变化、重新拉取结果）等属性。用于追溯数据修正历史和故障诊断。

- **邮件通知配置（EmailNotificationConfig）**: 记录邮件通知的配置信息，包含SMTP服务器地址（smtp.qq.com）、端口（587/465）、发件人账号（243219169@qq.com）、授权码、收件人地址列表等属性。用于预包装数据拉取失败时发送告警邮件。

---

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 第三方 MES 系统推送批次数据后，我方系统在 500 毫秒内完成数据接收、验证和入库，并返回成功响应
- **SC-002**: 定时任务每秒能够处理至少 50 个待拉取预包装明细的工单，调用第三方接口并完成数据入库
- **SC-003**: 预包装数据拉取成功率达到 99.5% 以上（排除第三方系统故障导致的失败）
- **SC-004**: 产线客户端通过板件码查询工单、批次、包装、板件信息时，90% 的查询在 200 毫秒内返回结果
- **SC-005**: 板件报工接口在 100 毫秒内完成报工记录的存储，支持产线实时报工需求
- **SC-006**: 系统在高并发场景下（每秒 100 个批次推送或 500 个板件查询），接口响应时间不超过 1 秒，无请求丢失
- **SC-007**: 定时任务的执行互斥机制有效防止并发执行，在任务执行期间新的调度周期不启动新任务，任务并发执行率为 0%
- **SC-008**: 预包装数据拉取失败后的指数退避重试机制成功率达到 95% 以上（在第三方系统恢复正常的前提下，3次重试内成功）
- **SC-009**: 系统在异常重启或宕机恢复后，能够在 5 分钟内自动恢复未完成的预包装数据拉取任务，无数据丢失
- **SC-010**: 产线客户端操作人员反馈，通过板件码查询功能能够快速定位板件信息，查询成功率达到 98% 以上（排除板件码输入错误）
- **SC-011**: 板件报工功能上线后，产线生产进度追踪准确率提升至 95% 以上，减少人工记录错误
- **SC-012**: 系统对接上线后，数据同步延迟（从第三方推送批次到预包装数据拉取完成）平均时间不超过 10 秒
- **SC-013**: 工单数据修正功能启用后，管理员能够在 2 分钟内完成状态重置操作，系统在下一个调度周期（1 秒内）自动触发重新拉取
- **SC-014**: 工单数据重新拉取过程中，板件报工记录保留率达到 100%，无报工数据丢失
- **SC-015**: 重新拉取预包装数据后，产线客户端查询到的板件信息准确率达到 100%，与上游第三方系统数据完全一致
- **SC-016**: 在工单数据修正过程中，并发的产线查询和报工请求不受影响，成功率保持 99% 以上
- **SC-017**: 工单数据修正操作的审计日志完整性达到 100%，所有修正操作均可追溯
- **SC-018**: 关键操作日志完整性达到 100%，所有批次推送、预包装拉取、状态变更、报工操作均有日志记录
- **SC-019**: 接口调用失败时，ERROR日志包含足够的上下文信息（批次号/工单号/板件码、错误码、错误消息），使运维人员能够在 5 分钟内定位问题原因
- **SC-020**: 性能指标采集覆盖率达到 100%，所有关键接口（批次推送、预包装拉取、产线查询、报工）的响应时间和吞吐量均有记录
- **SC-021**: 预包装数据拉取失败后，邮件通知在 30 秒内成功发送至管理员邮箱，邮件送达率达到 95% 以上（排除邮箱服务器故障）

---

## Assumptions

本规范基于以下合理假设：

1. **第三方 MES 系统接口稳定性**: 假设第三方 MES 系统的批次推送接口和预包装查询接口在正常情况下可用性达到 99% 以上，接口响应时间在 1 秒以内。

2. **批次与工单数据量**: 假设每个批次平均包含 5-10 个工单，每个工单对应的预包装数据包含 10-50 个箱码，每个箱码包含 20-100 个板件。单个批次的总板件数量在 1000-5000 之间。

3. **定时任务处理能力**: 假设定时任务每秒可以处理 50 个工单的预包装数据拉取，单个工单的预包装数据拉取和入库时间在 500 毫秒以内。

4. **产线查询频率**: 假设产线客户端每秒查询板件信息的请求量在 100-500 之间，单个查询请求的响应时间在 200 毫秒以内。

5. **板件报工频率**: 假设产线每秒报工的板件数量在 50-200 之间，单个报工请求的处理时间在 100 毫秒以内。

6. **数据完整性**: 假设第三方 MES 系统推送的批次和预包装数据结构完整，符合约定的 JSON 格式，必填字段不为空。

7. **网络环境**: 假设我方系统与第三方 MES 系统之间的网络环境稳定，网络延迟在 50 毫秒以内，偶发性网络异常可通过重试机制恢复。双方系统部署在同一内网环境或通过专线/VPN连接的安全网络中，通过网络隔离保证接口安全，不需要应用层认证机制。

8. **板件码唯一性**: 假设板件码在系统中是唯一的，不存在重复的板件码。产线客户端输入的板件码准确率在 95% 以上。

9. **状态字段扩展性**: 假设未来可能需要扩展更多的处理状态类型（如"部分成功"、"异常挂起"），当前状态字段设计需预留扩展空间。

10. **幂等性要求**: 假设批次推送接口需要支持幂等性，对于重复推送的相同批次号数据，系统根据业务规则更新现有数据（而非拒绝或报错）。定时任务通过执行互斥机制保证同一时间只有一个任务实例在运行，避免并发拉取导致的重复请求和数据冲突。

11. **工单数据修正频率**: 假设工单数据修正操作为低频操作，平均每天不超过 10 次，单次修正涉及的工单数量在 1-5 个之间。修正操作通常由管理员在发现数据异常后手动触发。

12. **报工记录独立性**: 假设报工记录与板件基础数据在物理存储上独立，报工记录通过板件码关联板件，即使板件被删除或更新，报工记录仍然保留，通过板件码可追溯到历史生产操作。

13. **数据修正时的并发控制**: 假设在工单数据修正（重新拉取）过程中，系统通过工单状态字段（"更新中"）标识数据正在更新，产线查询接口检测到此状态时返回"数据更新中"提示，避免返回不一致的中间状态数据。报工操作不受工单状态影响，独立写入报工表。

14. **板件数量变化处理**: 假设当重新拉取导致板件数量减少时，被删除板件的历史报工记录保留在数据库中，并通过状态字段标记为"关联板件已失效"。这些报工记录仍可用于生产追溯和数据分析，但在产线客户端查询时会提示"板件已失效"。

15. **定时任务执行时长**: 假设在正常情况下，单次定时任务执行时间不超过 1 秒（每秒处理 50 个工单）。如果待处理工单数量过多导致执行时间超过 1 秒，系统通过执行互斥机制自动跳过下一次调度，等待当前任务完成后再继续。

16. **失败工单运维方式**: 假设"拉取失败"状态的工单由运维人员通过数据库直接查询和手动修改状态来处理，系统不提供专门的管理后台UI或API接口。运维人员具备SQL操作能力，能够识别失败原因（通过日志或错误记录表）并手动重置工单状态为"未拉取"以触发重新拉取。

17. **邮件通知可靠性**: 假设邮件通知服务（QQ邮箱SMTP）在正常情况下可用性达到 99% 以上，邮件发送延迟在30秒以内。邮件发送失败（如网络异常、SMTP服务不可用）不阻塞主业务流程，系统仅记录ERROR日志，运维人员可通过日志或数据库查询识别拉取失败的工单。

18. **邮件通知频率**: 假设预包装数据拉取失败为低频事件，平均每天不超过 5 次失败通知。邮件内容包含足够的上下文信息（批次号、工单号、失败原因、重试次数），使管理员能够快速判断是否需要人工介入。
