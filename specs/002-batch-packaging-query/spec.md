# 功能规格说明：批次与包装层级查询

**Feature Branch**: `001-batch-packaging-query`  
**Created**: 2026-02-02  
**Status**: Draft  
**Input**: User description: "数据表er图结构是： mes_batch (批次表) ├── id (PK) ├── batch_num (UK) - 批次号 ├── batch_type - 批次类型（1~6） └── product_time - 生产日期 │ ├──> mes_optimizing_file (优化文件表)【1:N】 │ ├── id (PK) │ ├── batch_id (FK) → mes_batch.id │ ├── optimizing_file_name - 优化文件名 │ ├── station_code - 工位编码 │ └── urgency - 是否加急 │ │ │ └──> mes_work_order (工单表)【1:N】 │ ├── id (PK) │ ├── batch_id (FK) → mes_batch.id │ ├── optimizing_file_id (FK) → mes_optimizing_file.id │ ├── work_id (UK) - 工单号 │ ├── route - 线路 │ ├── order_type - 订单类型 │ └── prepackage_status - 拉取状态 │ │ │ └──> mes_prepackage_order (预包装订单表)【1:1】 │ ├── id (PK) │ ├── work_order_id (FK, UK) → mes_work_order.id │ ├── order_num - 订单号 │ ├── consignor - 客户名称 │ ├── receiver - 收货人 │ └── install_address - 安装地址 │ │ │ └──> mes_box (箱码表)【1:N】 │ ├── id (PK) │ ├── prepackage_order_id (FK) │ ├── box_code (UK) - 箱码 │ ├── building - 楼栋 │ ├── house - 户型 │ └── room - 房间号 │ │ │ └──> mes_package (包件表)【1:N】 │ ├── id (PK) │ ├── box_id (FK) │ ├── package_no - 第几包 │ ├── length/width/depth - 尺寸 │ ├── weight - 重量 │ └── box_type - 纸箱类型 │ │ │ └──> mes_part (板件表)【1:N】 │ ├── id (PK) │ ├── package_id (FK) │ ├── part_code (UK) - 部件条码 │ ├── layer/piece - 层/片 │ ├── item_code - 板件ID │ ├── mat_name - 花色 │ ├── item_length/width/depth - 尺寸 │ ├── x_axis/y_axis/z_axis - 坐标 │ ├── sort_order - 分拣顺序 │ └── standard_list - 标准码集合 │ └──> mes_work_report (报工记录表)【独立表，无物理外键】 ├── id (PK) ├── part_code - 部件条码（逻辑关联 mes_part.part_code） ├── part_status - 板件状态 ├── station_code - 工位编码 └── report_time - 报工时间 1、查询工单与批次信息接口是要返回mes_batch (批次表)下所有的层级的数据，结构按层级返回 2、查询包装数据接口是要返回mes_prepackage_order (预包装订单表)下所有的层级的数据，结构按层级返回"

## 用户场景与测试 *(mandatory)*

### 用户故事 1 - 获取完整批次层级 (Priority: P1)

作为生产/运营人员，我需要一次性获取某个批次及其全部下级数据，以便在一个视图中掌握完整生产上下文。

**优先级原因**: 批次级别的整体可视是最核心的业务需求，支持日常追踪与排查。

**独立测试**: 使用已知批次标识进行查询，确认返回的层级结构包含所有下级层次与字段。

**验收场景**:

1. **Given** 一个存在的批次标识，**When** 请求批次详情，**Then** 返回批次及全部下级层级（优化文件、工单、预包装订单、箱码、包件、板件）的层级结构。
2. **Given** 一个不存在的批次标识，**When** 请求批次详情，**Then** 返回明确的无结果提示且不返回部分数据。

---

### 用户故事 2 - 获取完整包装层级 (Priority: P2)

作为包装人员，我需要一次性获取某个预包装订单及其全部下级数据，以便在一个视图中核对包装细节与内容。

**优先级原因**: 包装核对是高频流程，但依赖完整的层级数据。

**独立测试**: 使用已知预包装订单标识进行查询，确认返回的层级结构包含所有下级层次与字段。

**验收场景**:

1. **Given** 一个存在的预包装订单标识，**When** 请求包装详情，**Then** 返回预包装订单及全部下级层级（箱码、包件、板件）的层级结构。

---

### 用户故事 3 - 关联查看板件报工记录 (Priority: P3)

作为主管，我需要在查询结果中看到板件对应的报工记录，以便快速确认生产状态，无需二次查询。

**优先级原因**: 报工信息用于状态确认，但依赖主查询结果。

**独立测试**: 查询包含报工记录的批次或预包装订单，确认报工记录随板件一起返回。

**验收场景**:

1. **Given** 板件存在报工记录，**When** 获取批次或预包装层级，**Then** 报工记录出现在对应板件下。

---

### 边界情况

- 批次下存在优化文件但没有工单时如何处理？
- 工单没有对应预包装订单时如何处理？
- 预包装订单下尚无箱码或包件时如何处理？
- 板件没有报工记录时如何处理？
- 存在无法匹配任何板件的报工记录时如何处理？

## 需求 *(mandatory)*

### 功能需求

- **FR-001**: 系统必须提供批次查询，返回该批次及全部下级层级的单一层级结构。
- **FR-002**: 系统必须提供预包装订单查询，返回该预包装订单及全部下级层级的单一层级结构。
- **FR-003**: 批次层级必须包含优化文件、工单、预包装订单、箱码、包件、板件及其定义字段。
- **FR-004**: 预包装层级必须包含箱码、包件、板件及其定义字段。
- **FR-005**: 对于返回的每个板件，若存在匹配的报工记录（按部件条码匹配），必须一并返回。
- **FR-006**: 当请求的标识不存在时，系统必须返回明确的无结果提示且不返回部分层级数据。
- **FR-007**: 当某层级没有数据时，必须返回空集合而不是省略该层级。
- **FR-008**: 层级的父子关系必须严格按照数据模型定义，不得跨父级关联。
- **FR-009**: 查询为只读操作，系统不得因查询改变任何生产数据。

### 关键实体 *(include if feature involves data)*

- **Batch（批次）**: 表示生产批次（批次号、批次类型、生产日期）；父级为优化文件与工单。
- **Optimizing File（优化文件）**: 表示批次优化文件（文件名、工位编码、是否加急）；父级为工单。
- **Work Order（工单）**: 表示生产工单（工单号、线路、订单类型、拉取状态）；父级为预包装订单。
- **Prepackage Order（预包装订单）**: 表示包装订单（订单号、客户名称、收货人、安装地址）；父级为箱码。
- **Box（箱码）**: 表示箱码及位置信息（箱码、楼栋、户型、房间号）；父级为包件。
- **Package（包件）**: 表示箱内包件（第几包、尺寸、重量、纸箱类型）；父级为板件。
- **Part（板件）**: 表示包件内板件（部件条码、层/片、板件ID、花色、尺寸、坐标、分拣顺序、标准码集合）。
- **Work Report（报工记录）**: 表示按部件条码关联的报工记录（板件状态、工位编码、报工时间）。

## 假设

- 批次查询以唯一批次标识（批次号）发起。
- 预包装订单查询以唯一订单标识发起（订单号或工单号）。
- 报工记录仅在部件条码匹配时返回，不匹配的记录不包含在查询结果中。
- 查询结果仅包含请求标识对应的层级范围，不包含无关批次或订单。

## 依赖

- 相关批次、包装、报工数据已在系统中存在且可用。

## 成功标准 *(mandatory)*

### 可衡量结果

- **SC-001**: 用户在包含最多 10,000 个板件的批次上，可在 5 秒内获取完整层级结果。
- **SC-002**: 用户在包含最多 2,000 个板件的预包装订单上，可在 3 秒内获取完整层级结果。
- **SC-003**: 至少 95% 的层级查询在首次请求中返回完整结果，无需追加查询。
- **SC-004**: 用户使用层级结果完成批次或包装核对的任务完成率达到 90% 以上。
